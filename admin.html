<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KD Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { background-color: #000; color: #ccc; }</style>
</head>
<body class="p-4">

    <div id="auth-check" class="fixed inset-0 bg-black z-50 flex items-center justify-center">
        <div class="text-center">
            <h2 class="text-xl font-bold text-white mb-2">Verifying Admin Access...</h2>
            <p id="auth-msg" class="text-gray-500">Please wait.</p>
            <button id="admin-login-btn" class="hidden mt-4 bg-white text-black px-4 py-2 rounded font-bold">Login as Admin</button>
        </div>
    </div>

    <div id="dashboard" class="hidden max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8 border-b border-gray-800 pb-4">
            <h1 class="text-3xl text-white font-bold">Admin Panel</h1>
            <button onclick="window.location.href='index.html'" class="text-blue-500">View Site</button>
        </div>

        <div class="flex gap-4 mb-6">
            <button onclick="showTab('orders')" class="px-4 py-2 bg-gray-800 rounded text-white hover:bg-gray-700">Orders</button>
            <button onclick="showTab('products')" class="px-4 py-2 bg-gray-800 rounded text-white hover:bg-gray-700">Products</button>
        </div>

        <div id="tab-orders" class="block">
            <h2 class="text-2xl font-bold text-white mb-4">Manage Orders</h2>
            <div id="admin-orders-list" class="space-y-4">Loading...</div>
        </div>

        <div id="tab-products" class="hidden">
            <div class="mb-8 bg-[#111] p-4 rounded border border-gray-800">
                <h3 class="text-white font-bold mb-4">Add New Product</h3>
                <input id="p-name" class="w-full bg-black border border-gray-700 p-2 mb-2 rounded" placeholder="Product Name">
                <input id="p-price" type="number" class="w-full bg-black border border-gray-700 p-2 mb-2 rounded" placeholder="Price">
                <input id="p-image" class="w-full bg-black border border-gray-700 p-2 mb-2 rounded" placeholder="Image URL">
                <textarea id="p-desc" class="w-full bg-black border border-gray-700 p-2 mb-2 rounded" placeholder="Description"></textarea>
                <textarea id="p-specs" class="w-full bg-black border border-gray-700 p-2 mb-2 rounded" placeholder="Specs"></textarea>
                <button onclick="addProduct()" class="w-full bg-green-600 text-white font-bold p-3 rounded">ADD PRODUCT</button>
            </div>
        </div>
    </div>

    <div id="ship-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[#111] p-6 rounded-xl border border-gray-800 w-full max-w-sm">
            <h3 class="text-xl font-bold text-white mb-4">Ship Order</h3>
            <input id="ship-partner" class="w-full bg-black border border-gray-700 p-2 mb-3 rounded text-white" placeholder="Delivery Partner Name">
            <input id="ship-track" class="w-full bg-black border border-gray-700 p-2 mb-4 rounded text-white" placeholder="Tracking ID">
            <button id="confirm-ship-btn" class="w-full bg-blue-600 text-white font-bold py-2 rounded">CONFIRM SHIPMENT</button>
            <button onclick="document.getElementById('ship-modal').classList.add('hidden')" class="w-full mt-2 text-gray-500 py-2">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { auth, db, signInWithEmailAndPassword, doc, setDoc, addDoc, updateDoc, collection, onAuthStateChanged, query, orderBy, onSnapshot } from './firebase-config.js';

        // 1. ADMIN AUTH CHECK (NO PASSWORD)
        const ADMIN_EMAIL = "admin@kd.com"; // HARDCODED ADMIN EMAIL CHECK

        onAuthStateChanged(auth, user => {
            const overlay = document.getElementById('auth-check');
            const msg = document.getElementById('auth-msg');
            const loginBtn = document.getElementById('admin-login-btn');

            if(user && user.email === ADMIN_EMAIL) {
                // SUCCESS: Is Admin
                overlay.style.display = 'none';
                document.getElementById('dashboard').classList.remove('hidden');
                loadOrders();
            } else if (user) {
                // Logged in but NOT Admin
                msg.innerText = "Access Denied. You are not an Admin.";
                loginBtn.classList.remove('hidden');
                loginBtn.innerText = "Switch Account";
                loginBtn.onclick = () => { auth.signOut(); location.reload(); };
            } else {
                // Not logged in
                msg.innerText = "Admin Login Required";
                loginBtn.classList.remove('hidden');
                loginBtn.onclick = async () => {
                    const e = prompt("Email:");
                    const p = prompt("Password:");
                    try { await signInWithEmailAndPassword(auth, e, p); } 
                    catch(err) { alert(err.message); }
                };
            }
        });

        // 2. TAB SWITCHING
        window.showTab = (tabName) => {
            document.getElementById('tab-orders').style.display = tabName === 'orders' ? 'block' : 'none';
            document.getElementById('tab-products').style.display = tabName === 'products' ? 'block' : 'none';
        };

        // 3. ORDER MANAGEMENT
        let currentOrderId = null;

        function loadOrders() {
            const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('admin-orders-list');
                list.innerHTML = "";
                snap.forEach(d => {
                    const o = d.data();
                    list.innerHTML += `
                    <div class="bg-[#151515] p-4 rounded border border-gray-800 mb-4">
                        <div class="flex justify-between mb-2">
                            <span class="font-bold text-white">Order #${d.id.slice(0,6)}</span>
                            <span class="text-sm font-mono">${o.status}</span>
                        </div>
                        <p class="text-sm text-gray-400 mb-2">User: ${o.userId}</p>
                        <p class="text-sm text-gray-400 mb-2">Address: ${o.address}</p>
                        <div class="flex gap-2 mt-3 flex-wrap">
                            <button onclick="updateStatus('${d.id}', 'Confirmed')" class="px-3 py-1 bg-green-900 text-green-200 text-xs rounded">Confirm</button>
                            <button onclick="openShipModal('${d.id}')" class="px-3 py-1 bg-blue-900 text-blue-200 text-xs rounded">Mark Shipped</button>
                            <button onclick="updateStatus('${d.id}', 'Delivered')" class="px-3 py-1 bg-gray-700 text-white text-xs rounded">Delivered</button>
                            <button onclick="cancelOrder('${d.id}')" class="px-3 py-1 bg-red-900 text-red-200 text-xs rounded">Cancel</button>
                        </div>
                    </div>`;
                });
            });
        }

        // Global functions for HTML buttons
        window.updateStatus = async (id, status) => {
            await updateDoc(doc(db, "orders", id), { status: status });
        };

        window.openShipModal = (id) => {
            currentOrderId = id;
            document.getElementById('ship-modal').classList.remove('hidden');
        };

        document.getElementById('confirm-ship-btn').addEventListener('click', async () => {
            const partner = document.getElementById('ship-partner').value;
            const track = document.getElementById('ship-track').value;
            
            if(currentOrderId && partner && track) {
                await updateDoc(doc(db, "orders", currentOrderId), {
                    status: "Shipped",
                    deliveryPartner: partner,
                    trackingId: track
                });
                document.getElementById('ship-modal').classList.add('hidden');
                alert("Order Shipped!");
            } else {
                alert("Please fill all fields");
            }
        });

        window.cancelOrder = async (id) => {
            if(confirm("Are you sure you want to Cancel this order?")) {
                // Updates status to Cancelled AND removes shipping info (sets to null/delete)
                await updateDoc(doc(db, "orders", id), { 
                    status: "Cancelled",
                    deliveryPartner: request.delete(), // Or just null/empty string
                    trackingId: "" 
                });
            }
        };
        
        // Product Function (Kept from before)
        window.addProduct = async () => {
             await addDoc(collection(db, "products"), {
                name: document.getElementById('p-name').value,
                price: Number(document.getElementById('p-price').value),
                image: document.getElementById('p-image').value,
                desc: document.getElementById('p-desc').value,
                specs: document.getElementById('p-specs').value,
                createdAt: new Date()
            });
            alert("Product Added!");
            location.reload();
        };
    </script>
</body>
</html>