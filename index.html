<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KD Drones | Premium Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { 'kd-red': '#D72638', 'kd-dark': '#0a0a0a' } } }
        }
    </script>
    <style>
        body { background-color: #050505; color: #e5e5e5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .slider-scroll::-webkit-scrollbar { display: none; }
        .product-card { transition: transform 0.2s; }
        .product-card:active { transform: scale(0.98); }
    </style>
</head>
<body>

    <div id="navbar"></div>

    <div class="max-w-screen-xl mx-auto px-4 pt-4 mt-2">
        <div class="relative group">
            <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none">
                <svg class="w-5 h-5 text-gray-500 group-focus-within:text-red-500 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <input type="text" id="search-input" class="block w-full p-4 pl-12 text-sm text-white border border-gray-800 rounded-full bg-[#111] focus:border-red-600 focus:ring-1 focus:ring-red-600 focus:outline-none transition shadow-lg placeholder-gray-500" placeholder="Search for drones, parts..." required>
        </div>
    </div>

    <div class="relative w-full overflow-hidden mt-6" id="home-slider">
        <div id="slider-track" class="flex transition-transform duration-500 ease-out h-[50vh] md:h-[600px]">
            </div>
        <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-2" id="slider-dots"></div>
    </div>

    <section id="products" class="max-w-screen-xl mx-auto p-4 mt-4 pb-20">
        <div class="flex justify-between items-end mb-6">
            <h2 class="text-3xl font-bold tracking-tight text-white">Latest Drones</h2>
            <span id="result-count" class="text-xs text-gray-500 hidden">Showing all</span>
        </div>
        
        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="animate-pulse bg-gray-800 h-64 rounded-xl"></div>
            <div class="animate-pulse bg-gray-800 h-64 rounded-xl"></div>
        </div>
    </section>

    <script type="module">
        import { db, loadNavbar, collection, getDocs, formatINR } from './firebase-config.js';

        loadNavbar();

        // Global variable to store all products for searching
        let allProducts = [];

        // 1. Load Slider
        const sliderTrack = document.getElementById('slider-track');
        getDocs(collection(db, "slider")).then(snap => {
            if(snap.empty) {
                sliderTrack.innerHTML = `<div class="w-full flex-shrink-0 bg-gray-800 flex items-center justify-center h-full"><h2>No Slides Configured</h2></div>`;
                return;
            }
            let slides = "";
            snap.forEach(doc => {
                const data = doc.data();
                slides += `
                <div class="w-full flex-shrink-0 relative cursor-pointer" onclick="window.location.href='${data.link || '#'}'">
                    <img src="${data.image}" class="w-full h-full object-cover">
                    <div class="absolute bottom-0 bg-gradient-to-t from-black to-transparent w-full p-8">
                        <h2 class="text-2xl font-bold text-white drop-shadow-lg">${data.title || ''}</h2>
                    </div>
                </div>`;
            });
            sliderTrack.innerHTML = slides;
            
            // Auto Scroll
            let index = 0;
            const total = snap.size;
            if(total > 1) {
                setInterval(() => {
                    index = (index + 1) % total;
                    sliderTrack.style.transform = `translateX(-${index * 100}%)`;
                }, 4000);
            }
        });

        // 2. Load Products & Initialize Search
        const grid = document.getElementById('product-grid');
        const searchInput = document.getElementById('search-input');
        const resultCount = document.getElementById('result-count');

        async function initProducts() {
            const snap = await getDocs(collection(db, "products"));
            
            if(snap.empty) { 
                grid.innerHTML = "<p class='col-span-full text-center text-gray-500'>No products found.</p>"; 
                return; 
            }
            
            // Store data globally
            allProducts = [];
            snap.forEach(doc => {
                allProducts.push({ id: doc.id, ...doc.data() });
            });

            // Initial Render
            renderProducts(allProducts);
        }

        // 3. Render Function (Used for Init & Search)
        function renderProducts(productList) {
            grid.innerHTML = "";
            
            if(productList.length === 0) {
                grid.innerHTML = `
                <div class="col-span-full text-center py-10">
                    <p class="text-gray-500">No products match your search.</p>
                </div>`;
                return;
            }

            productList.forEach(p => {
                const priceVal = p.price ? Number(p.price) : 0;
                const displayImage = (p.images && p.images.length > 0) ? p.images[0] : p.image;

                grid.innerHTML += `
                <div class="product-card bg-[#111] border border-gray-800 rounded-xl overflow-hidden cursor-pointer group hover:border-gray-600 transition" onclick="window.location.href='product.html?id=${p.id}'">
                    <div class="h-40 w-full bg-gray-900 overflow-hidden relative">
                         <img src="${displayImage}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                    </div>
                    <div class="p-3">
                        <h3 class="text-white font-semibold text-lg truncate">${p.name}</h3>
                        <p class="text-gray-400 text-xs mt-1 truncate line-clamp-2">${p.desc}</p>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-kd-red font-bold text-lg">${formatINR(priceVal)}</span>
                            <button class="bg-white text-black text-xs px-3 py-1 rounded-full font-bold hover:bg-gray-200">BUY</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        // 4. Search Logic (Live Filter)
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            
            const filtered = allProducts.filter(p => 
                p.name.toLowerCase().includes(term) || 
                (p.desc && p.desc.toLowerCase().includes(term))
            );

            renderProducts(filtered);

            // Update result text
            if(term.length > 0) {
                resultCount.classList.remove('hidden');
                resultCount.innerText = `Found ${filtered.length} result(s)`;
            } else {
                resultCount.classList.add('hidden');
            }
        });

        // Run Logic
        initProducts();

    </script>
</body>
</html>