<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KD Drones | Premium Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { 'kd-red': '#D72638', 'kd-dark': '#0a0a0a' } } }
        }
    </script>
    <style>
        body { background-color: #050505; color: #e5e5e5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .slider-scroll::-webkit-scrollbar { display: none; }
        .product-card { transition: transform 0.2s; }
        .product-card:active { transform: scale(0.98); }
    </style>
</head>
<body>

    <div id="navbar"></div>

    <div class="relative w-full overflow-hidden mt-2" id="home-slider">
        <div id="slider-track" class="flex transition-transform duration-500 ease-out h-[50vh] md:h-[600px]">
            </div>
        <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-2" id="slider-dots"></div>
    </div>

    <section id="products" class="max-w-screen-xl mx-auto p-4 mt-4 pb-20">
        <div class="flex justify-between items-end mb-6">
            <h2 class="text-3xl font-bold tracking-tight text-white">Latest Drones</h2>
            <span id="result-count" class="text-xs text-gray-500 hidden">Showing all</span>
        </div>
        
        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="animate-pulse bg-gray-800 h-64 rounded-xl"></div>
            <div class="animate-pulse bg-gray-800 h-64 rounded-xl"></div>
        </div>
    </section>

    <script type="module">
        import { db, loadNavbar, collection, getDocs, formatINR } from './firebase-config.js';

        // 1. Load Navbar (IMMEDIATELY)
        loadNavbar();

        let allProducts = [];

        // 2. Load Slider
        const sliderTrack = document.getElementById('slider-track');
        getDocs(collection(db, "slider")).then(snap => {
            if(snap.empty) {
                sliderTrack.innerHTML = `<div class="w-full flex-shrink-0 bg-gray-800 flex items-center justify-center h-full"><h2>No Slides Configured</h2></div>`;
                return;
            }
            let slides = "";
            snap.forEach(doc => {
                const data = doc.data();
                slides += `
                <div class="w-full flex-shrink-0 relative cursor-pointer bg-black" onclick="window.location.href='${data.link || '#'}'">
                    <img src="${data.image}" class="w-full h-full object-contain">
                    <div class="absolute bottom-0 bg-gradient-to-t from-black via-black/50 to-transparent w-full p-8 pointer-events-none">
                        <h2 class="text-2xl font-bold text-white drop-shadow-lg">${data.title || ''}</h2>
                    </div>
                </div>`;
            });
            sliderTrack.innerHTML = slides;
            
            let index = 0;
            const total = snap.size;
            if(total > 1) {
                setInterval(() => {
                    index = (index + 1) % total;
                    sliderTrack.style.transform = `translateX(-${index * 100}%)`;
                }, 4000);
            }
        });

        // 3. Load Products & Initialize Search Logic
        const grid = document.getElementById('product-grid');
        const resultCount = document.getElementById('result-count');

        async function initProducts() {
            const snap = await getDocs(collection(db, "products"));
            
            if(snap.empty) { 
                grid.innerHTML = "<p class='col-span-full text-center text-gray-500'>No products found.</p>"; 
                return; 
            }
            
            allProducts = [];
            snap.forEach(doc => {
                allProducts.push({ id: doc.id, ...doc.data() });
            });

            renderProducts(allProducts);
        }

        function renderProducts(productList) {
            grid.innerHTML = "";
            
            if(productList.length === 0) {
                grid.innerHTML = `
                <div class="col-span-full text-center py-10">
                    <p class="text-gray-500">No products match your search.</p>
                </div>`;
                return;
            }

            productList.forEach(p => {
                const priceVal = p.price ? Number(p.price) : 0;
                const displayImage = (p.images && p.images.length > 0) ? p.images[0] : p.image;

                grid.innerHTML += `
                <div class="product-card bg-[#111] border border-gray-800 rounded-xl overflow-hidden cursor-pointer group hover:border-gray-600 transition" onclick="window.location.href='product.html?id=${p.id}'">
                    <div class="h-40 w-full bg-gray-900 overflow-hidden relative">
                         <img src="${displayImage}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                    </div>
                    <div class="p-3">
                        <h3 class="text-white font-semibold text-lg truncate">${p.name}</h3>
                        <p class="text-gray-400 text-xs mt-1 truncate line-clamp-2">${p.desc}</p>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-kd-red font-bold text-lg">${formatINR(priceVal)}</span>
                            <button class="bg-white text-black text-xs px-3 py-1 rounded-full font-bold hover:bg-gray-200">BUY</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        // 4. Safe Search Listener
        // We wait 100ms to ensure the Navbar HTML is fully in the DOM
        setTimeout(() => {
            const searchInput = document.getElementById('search-input');
            if(searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase().trim();
                    const filtered = allProducts.filter(p => {
                        const pName = p.name ? p.name.toLowerCase() : "";
                        const pDesc = p.desc ? p.desc.toLowerCase() : "";
                        return pName.includes(term) || pDesc.includes(term);
                    });
                    renderProducts(filtered);
                    if(term.length > 0) {
                        resultCount.classList.remove('hidden');
                        resultCount.innerText = `Found ${filtered.length} result(s)`;
                    } else {
                        resultCount.classList.add('hidden');
                    }
                });
            }
        }, 100);

        initProducts();
    </script>
</body>
</html>